version: "3.5"

services:
  bibcnrs-api-dev-server:
    container_name: bibcnrs-dev-api
    image: node:14.21.2-bullseye-slim
    volumes:
      - .:/app
    working_dir: /app
    environment:
      NODE_ENV: development
      http_proxy: ${http_proxy}
      https_proxy: ${https_proxy}
      BIBAPI_HOST: ${BIBAPI_HOST}
      BIB_CONTENT_DELIVERY_HOST: ${BIBAPI_HOST}
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: secret
      POSTGRES_DB: bibapi-dev
      POSTGRES_HOST: bibcnrs-dev-api-postgres
      REDIS_HOST: bibcnrs-dev-api-redis
      MAIL_SERVER_HOST: bibcnrs-dev-api-mail
      MAIL_SERVER_PORT: 1025
      EZ_UNPAYWALL_URL: "${EZ_UNPAYWALL_URL}"
      EZ_UNPAYWALL_KEY: "${EZ_UNPAYWALL_KEY}"
      DATABASE_URL: postgres://postgres:secret@bibcnrs-dev-api-postgres:5432/bibapi-dev
      METADORE_URL: "${METADORE_URL}"
      METADORE_API_KEY: "${METADORE_API_KEY}"
      DOAJ_URL: ${DOAJ_URL}
    ports:
      - "3000:3000"
    command: npm run dev
    networks:
      - bib-backend-network
      - bib-frontend-network
    depends_on:
      - bibcnrs-api-dev-server-postgres
      - bibcnrs-api-dev-server-redis
      - bibcnrs-api-dev-server-mail

  bibcnrs-api-dev-server-adminer:
    container_name: bibcnrs-dev-api-adminer
    image: adminer:4
    ports:
      - "8080:8080"
    networks:
      - bib-backend-network
    depends_on:
      - bibcnrs-api-dev-server-postgres

  # Application database
  bibcnrs-api-dev-server-postgres:
    container_name: bibcnrs-dev-api-postgres
    image: postgres:13
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: secret
      POSTGRES_DB: bibapi-dev
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - ./backups:/backups
      - ./postgresql-dev:/var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    networks:
      - bib-backend-network

  # Cache database
  bibcnrs-api-dev-server-redis:
    container_name: bibcnrs-dev-api-redis
    image: redis:6.2.6
    networks:
      - bib-backend-network

  # Mail dev server
  bibcnrs-api-dev-server-mail:
    image: maildev/maildev:2.0.5
    container_name: bibcnrs-dev-api-mail
    ports:
      - "1080:1080"
      - "1025:1025"
    networks:
      - bib-backend-network

networks:
  bib-backend-network:
    driver: bridge
    name: bib-backend-network
  bib-frontend-network:
    driver: bridge
    name: bib-frontend-network
